<!DOCTYPE html>

<html>

<head>
    <style>
        #playlist-container {
            display: flex;
            flex-direction: column;
        }
    </style>
</head>

<body onload="load_info()">
    <h1>Predelli music</h1>
    <p></p>
    <form method="get">
        <input type="text" placeholder="search" name="search">
        <input type="submit">
    </form>

    <h2>Actions</h2>
    <a href="musics.html"><button>tutte le canzoni</button></a>
    <a href="login.html"><button>login</button></a>
    <a href="new-song.html"><button>aggiungi una canzone</button></a>
    <button id="logout">log out</button>
    <button id="scan-again">scan again</button>

    <h2>Playlists</h2>
    <a href="new-playlist.html"><button>add new</button></a>
    <div id="playlist-container"></div>

    <script>
        const p = document.querySelector("p");
        const playcontainer = document.getElementById("playlist-container");
        const logout = document.getElementById("logout");
        const scan_button = document.getElementById("scan-again");
        const new_playlist_button = document.getElementById("new-playlist");


        const form_data = new FormData();
        form_data.append("token", sessionStorage.getItem("API_token"));



        async function load_info() {
            if (sessionStorage.getItem("scanned") == true) {
                const result = await api_request("scan", "post", form_data);
            }

            const playlist = await api_request("playlists", "post", form_data)
            playlist.forEach(p => {
                const link = document.createElement("a");
                link.innerText = p.name;
                link.href = "musics.html?playlist=" + p.name;
                playcontainer.appendChild(link);
            });

        }


        scan_button.addEventListener("click", async function () {
            console.log("click");
            p.innerText = "updating tracks (first log in could take a while)";
            const result = await api_request("scan", "post", form_data);
            p.innerText = "tracks updated";
        })

        logout.addEventListener("click", function () {
            sessionStorage.clear();
            window.location.replace("index.html");
        })

        console.log('sessionStorage.getItem("API_token") :>> ', sessionStorage.getItem("API_token"));

        function get_template_form(meth, form_data) {
            return {
                method: meth,
                body: form_data
            }
        }

        async function api_request(route, method, form_data) {
            const API = "https://apimusic.predelli.site";
            const API_ROUTE = API + "/" + route;
            try {
                const response = await fetch(API_ROUTE, get_template_form(method, form_data));
                if (!response.ok) {
                    throw new Error("Response status :" + response.status);
                }

                const result = await response.json();

                return result;
            } catch (error) {
                console.error(error.message);
            }
        }
    </script>
</body>


</html>
